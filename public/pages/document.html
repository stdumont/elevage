<section class="content-header">

    <h1>
        Documents
        <small>Gestion des documents</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="javascript:void(0)"><i class="fa fa-files-o active"></i> Documents</a></li>
    </ol>

</section>

<!-- Main content -->
<section class="content">

    <div class="row">

        <div class="col-md-9">

            <div class="box box-info box-recherche" id="box-recherche">
                <div class="box-header with-border">
                    <h3 class="box-title"><i class="fa fa-search"></i> Rechercher un document</h3>

                    <div class="box-tools pull-right">
                        <button class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body" style="padding-top:0px;">
                    <!--
                        CRITERES DE RECHERCHE
                    -->
                    <div class="row">
                        <!-- Filtre -->
                        <div class="col-md-6" style="margin-top:5px;">
                            <input type="text" class="form-control" ng-model="inputSearchCriteria" placeholder="Filtre" ng-keyup="$event.keyCode == 13 && rechercher()" empty-to-null />
                        </div>
                        <!-- Types de documents -->
                        <div class="col-md-6" style="margin-top:5px;">
                            <select class="inputSearchTypedoc" style="width:100%;"></select>
                        </div>
                    </div>
                    <div class="row" style="padding-bottom:6px;">
                        <!-- Clients -->
                        <div class="col-md-6" style="margin-top:5px;">
                            <select class="inputSearchClients" style="width:100%;"></select>
                        </div>
                        <!-- Fournisseurs -->
                        <div class="col-md-6" style="margin-top:5px;">
                            <select class="inputSearchFournisseurs" style="width:100%;"></select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <!-- Date de document début -->
                            <div class="col-md-6">
                                <component-datepicker ng-model="inputSearchDateDebut" id="inputSearchDateDebut" style="width:100%;" />
                            </div>
                            <!-- Date de document fin -->
                            <div class="col-md-6">
                                <component-datepicker ng-model="inputSearchDateFin" id="inputSearchDateFin" style="width:100%;" />
                            </div>
                        </div>
                    </div>

                </div>
                <!-- /.box-body -->
                <div class="box-footer">
                    <div class="pull-right">
                        <button class="btn btn-info" ng-click="rechercher()">Rechercher</button>
                    </div>
                    <div class="pull-left">
                        <button class="btn btn-default" ng-click="effacerCriteres()">Effacer les critères</button>
                    </div>
                </div>

            </div>

        </div>

        <div class="col-md-3">

            <div class="box box-info" id="box-ajout">
                <div class="box-header with-border">
                    <h3 class="box-title"><i class="fa fa-plus"></i> Ajouter un document</h3>

                    <div class="box-tools pull-right">
                        <button class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <input type="button" value="Ajouter un document" ng-click="askCreationDoc()" class="btn btn-info" style="width:100%;" />
                        </div>
                    </div>
                </div>
                <!-- /.box-body -->

            </div>

        </div>


    </div>
    <div class="row">
        <div class="col-md-12">

            <!-- TABLE RESULTAT DOCUMENTS -->
            <div class="box box-info box-documents" id="documentsSearch">

                <div class="box-header with-border">
                    <h3 class="box-title"><i class="fa fa-file-o"></i>&nbsp;&nbsp;<span ng-bind="resultatTitle"></span></h3>
                    <div class="box-tools pull-right">
                        <button class="btn btn-default" ng-click="toggleSum()">
                                Totaux
                        </button>
                        <button class="btn btn-box-tool" data-widget="collapse">
                                <i class="fa fa-minus"></i>
                        </button>
                    </div>

                </div>
                <!-- /.box-header -->

                <div class="box-body">

                    <script id="document_ng_header" type="text/ng-template">
                        <tr>
                            <th ng-repeat="column in columns" ng-show="column.visible" class="text-center" style="display: table-cell;">
                                {{column.title}}
                            </th>
                        </tr>
                    </script>

                    <table ng-table="tableDocuments" template-header="document_ng_header" class="table table-condensed table-bordered table-striped table-with-tooltip">
                        <tr ng-repeat="document in $data" style="cursor:pointer;">
                            <td data-title="'No'" class="text-center" ng-click="askViewDoc(document)">{{document.id}}</td>
                            <td data-title="'Type'" ng-click="askViewDoc(document)">{{document.typedoc.nom}}</td>
                            <td data-title="'Date'" class="text-center" ng-click="askViewDoc(document)">{{getDateJJMMYYYY(document.date_document)}}</td>
                            <td data-title="'Echéance'" class="text-center" ng-class="isDocumentEchu(document) ? 'text-danger text-bold' : ''" ng-click="askViewDoc(document)">{{getDateJJMMYYYY(document.date_echeance)}}</td>
                            <td data-title="'Nom'" ng-click="askViewDoc(document)">{{document.nom | limitTo:32}}
                                <div class="table-tooltip">
                                    <h5><i class="fa fa-comments-o"></i>&nbsp;Description</h5>
                                    <p ng-bind="document.description"></p>
                                </div>
                            </td>
                            <td data-title="'R/D'" class="text-center" ng-click="askViewDoc(document)">{{document.rd}}</td>
                            <td data-title="'Contrepartie'" ng-click="askViewDoc(document)">{{getContrepartie(document)}}</td>
                            <td data-title="'Montant'" class="text-right" ng-click="askViewDoc(document)">{{getMontantFr(document.montant_tvac)}}</td>
                            <td data-title="'Payé'" class="text-right" ng-click="askViewDoc(document)">{{getMontantFr(document.regle)}}</td>
                            <td data-title="'Solde'" class="text-right" ng-click="askViewDoc(document)">{{getMontantFr(document.solde)}}</td>
                            <td class="text-center"><i class="fa fa-file-pdf-o" ng-click="askManagePieces(document)"></i>&nbsp;<span class="badge" ng-show="document.pieces.length >= 1" ng-click="askManagePieces(document)">{{document.pieces.length}}</span></td>
                            <td class="text-center" ng-click="askUpdateDoc(document)"><i class="fa fa-edit"></i></td>
                            <td class="text-center" ng-click="askDeleteDoc(document)"><i class="fa fa-remove text-danger"></i></td>
                        </tr>
                        <tr ng-show="showSum">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td data-title="'R/D'" class="text-center text-success text-bold">R</td>
                            <td></td>
                            <td data-title="'Montant'" class="text-right text-success text-bold">{{getSommeMontantTvacRecette()}}</td>
                            <td data-title="'Payé'" class="text-right text-success text-bold">{{getSommeRegleRecette()}}</td>
                            <td data-title="'Solde'" class="text-right text-success text-bold">{{getSommeSoldeRecette()}}</td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr ng-show="showSum">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td data-title="'R/D'" class="text-center text-danger text-bold">D</td>
                            <td></td>
                            <td data-title="'Montant'" class="text-right text-danger text-bold">{{getSommeMontantTvacDepense()}}</td>
                            <td data-title="'Payé'" class="text-right text-danger text-bold">{{getSommeRegleDepense()}}</td>
                            <td data-title="'Solde'" class="text-right text-danger text-bold">{{getSommeSoldeDepense()}}</td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr ng-show="showSum">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td data-title="'R/D'" class="text-center text-info text-bold">S</td>
                            <td></td>
                            <td data-title="'Montant'" class="text-right text-info text-bold">{{getSoldeMontantTvac()}}</td>
                            <td data-title="'Payé'" class="text-right text-info text-bold">{{getSoldeRegle()}}</td>
                            <td data-title="'Solde'" class="text-right text-info text-bold">{{getSoldeSolde()}}</td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </table>


                </div>
                <!-- /.box-body -->

                <div class="loadingHidden overlay">
                    <i class="fa fa-refresh fa-spin"></i>
                </div>

            </div>
            <!-- FIN TABLE RECHERCHE DOCUMENTS -->


</section>
<!-- /.content -->

<!-- DEBUT MODAL AJOUT/MISE A JOUR/VISUALISATION DOCUMENT -->
<div class="modal fade" id="modalAddUpdateDoc">
    <div class="modal-dialog modal-lg">
        <div class="modal-content loadable form-createUpdate-document">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel" ng-bind="creationUpdateModalLabel"></h4>
            </div>
            <div class="modal-body" style="padding-top:5px;">
                <div class="box-body" style="padding-top:0px">

                    <!-- TYPE DE DOCUMENT -->
                    <div class="row" style="margin-bottom:8px;margin-top:5px;">
                        <div class="form-group">
                            <label for="inputTypedoc" class="col-md-2 control-label">Type *</label>
                            <div class="col-md-5" ng-show="editmode === 'View'">
                                <input type="text" class="form-control" ng-model="currentDocument.typedoc.nom" ng-disabled="disabled" id="inputTypedoc" name="inputTypedoc" />
                            </div>
                            <div class="col-md-5" ng-hide="editmode === 'View'">
                                <select class="inputTypedoc" ng-model="currentDocument.typedoc.id" style="width:100%;"></select>
                            </div>
                        </div>
                    </div>

                    <!-- DATE DU DOCUMENT -->
                    <div class="row" style="margin-bottom:8px;margin-top:5px;">
                        <div class="form-group">
                            <label for="inputDatedoc" class="col-md-2 control-label">Date document *</label>
                            <div class="col-md-2" ng-show="editmode === 'View'">
                                <input type="text" class="form-control" ng-model="currentDocument.date_document" ng-disabled="disabled" id="inputDatedoc" name="inputDatedoc" />
                            </div>
                            <div class="col-md-3" ng-hide="editmode === 'View'">
                                <component-datepicker ng-model="currentDocument.date_document" style="width:100%;" />
                            </div>

                        </div>
                    </div>

                    <!-- DATE D'ECHEANCE -->
                    <div class="row" style="margin-bottom:8px;margin-top:5px;">
                        <div class="form-group">
                            <label for="inputDateech" class="col-md-2 control-label">Date échéance</label>
                            <div class="col-md-2" ng-show="editmode === 'View'">
                                <input type="text" class="form-control" ng-model="currentDocument.date_echeance" ng-disabled="disabled" id="inputDateech" name="inputDateech" />
                            </div>
                            <div class="col-md-3" ng-hide="editmode === 'View'">
                                <component-datepicker ng-model="currentDocument.date_echeance" style="width:100%;" />
                            </div>

                        </div>
                    </div>

                    <!-- NOM -->
                    <div class="row" style="margin-bottom:8px;">
                        <div class="form-group">
                            <label for="inputNom" class="col-md-2 control-label">Nom *</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control" ng-model="currentDocument.nom" ng-disabled="disabled" id="inputNom" name="inputNom" empty-to-null />
                            </div>
                        </div>
                    </div>

                    <!-- DESCRIPTION -->
                    <div class="row" style="margin-bottom:8px;">
                        <div class="form-group">
                            <label for="inputDescription" class="col-md-2 control-label">Description</label>
                            <div class="col-md-10">
                                <textarea class="form-control" ng-model="currentDocument.description" ng-disabled="disabled" id="inputDescription" name="inputDescription" empty-to-null></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- RECETTE/DEPENSE -->
                    <div class="row" style="margin-bottom:8px;">
                        <div class="form-group">
                            <label for="inputRD" class="col-md-2 control-label">Dépense/Recette</label>
                            <div class="col-md-1">
                                <input type="text" class="form-control" ng-model="currentDocument.rd" ng-disabled="disabled" id="inputRD" name="inputRD" empty-to-null uppercased/>
                            </div>
                        </div>
                    </div>

                    <!-- COMMUNICATION -->
                    <div class="row" style="margin-bottom:8px;" ng-show="currentDocument.rd === 'D' || currentDocument.rd === 'R'">
                        <div class="form-group">
                            <label for="inputCommunication" class="col-md-2 control-label">Communication</label>
                            <div class="col-md-3">
                                <input type="text" class="form-control" ng-model="currentDocument.communication" ng-disabled="disabled" id="inputCommunication" name="inputCommunication" empty-to-null/>
                            </div>
                        </div>
                    </div>

                    <!-- FOURNISSEUR/CLIENT -->
                    <div class="row" style="margin-bottom:8px;" ng-show="currentDocument.rd === 'D' || currentDocument.rd === 'R'">
                        <div class="form-group">
                            <label for="inputFournisseur" class="col-md-2 control-label" ng-show="currentDocument.rd === 'D'">Fournisseur *</label>
                            <label for="inputClient" class="col-md-2 control-label" ng-show="currentDocument.rd === 'R'">Client *</label>
                            <div class="col-md-10" ng-show="editmode === 'View'">
                                <input type="text" class="form-control" ng-model="currentDocument.fournisseur.nom" ng-show="currentDocument.rd === 'D'" ng-disabled="disabled" id="inputTypedoc" name="inputTypedoc" />
                                <input type="text" class="form-control" ng-model="currentDocument.client.nom" ng-show="currentDocument.rd === 'R'" ng-disabled="disabled" id="inputTypedoc" name="inputTypedoc" />
                            </div>
                            <div class="col-md-10" ng-hide="editmode === 'View'">
                                <div ng-show="currentDocument.rd==='D'">
                                    <select class="inputFournisseur " ng-model="currentDocument.fournisseur.id " style="width:100%; "></select>
                                </div>
                                <div ng-show="currentDocument.rd==='R'">
                                    <select class="inputClient" ng-model="currentDocument.client.id" style="width:100%;"></select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MONTANT -->
                    <div class="row" style="margin-bottom:8px;" ng-show="currentDocument.rd === 'D' || currentDocument.rd === 'R'">
                        <div class="form-group">
                            <label for="inputMontant" class="col-md-2 control-label" ng-show="currentDocument.rd === 'D'">A payer *</label>
                            <label for="inputMontant" class="col-md-2 control-label" ng-show="currentDocument.rd === 'R'">A recevoir *</label>
                            <div class="col-md-2">
                                <input type="decimal" class="form-control" ng-model="currentDocument.montant_tvac" ng-disabled="disabled" id="inputMontant" name="inputMontant" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <!-- REGLE -->
                    <div class="row" style="margin-bottom:8px;" ng-show="currentDocument.rd === 'D' || currentDocument.rd === 'R'">
                        <div class="form-group">
                            <label for="inputRegle" class="col-md-2 control-label" ng-show="currentDocument.rd === 'D'">Payé *</label>
                            <label for="inputRegle" class="col-md-2 control-label" ng-show="currentDocument.rd === 'R'">Reçu *</label>
                            <div class="col-md-2">
                                <input type="decimal" class="form-control" ng-model="currentDocument.regle" ng-disabled="disabled" id="inputRegle" name="inputRegle" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <!-- SOLDE -->
                    <div class="row" style="margin-bottom:0px;" ng-show="currentDocument.rd === 'D' || currentDocument.rd === 'R'">
                        <div class="form-group">
                            <label for="inputSolde" class="col-md-2 control-label">Solde</label>
                            <div class="col-md-2">
                                <input type="decimal" class="form-control" ng-model="currentDocument.solde" ng-disabled="true" id="inputSolde" name="inputSolde" step="0.01" />
                            </div>
                        </div>
                    </div>


                    <div class="box callout callout-danger" ng-show="documentFormError">
                        <h4><i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;Validation annulée</h4>
                        <p ng-bind="documentFormErrorMessage"></p>
                    </div>

                </div>
                <!-- /.box-body -->
            </div>

            <div class="modal-footer">
                <div ng-hide="editmode == 'View'">
                    <button id="btnOkAddDocument" type="button" ng-click="createUpdateDocument()" class="btn btn-info"><span class="fa fa-check"></span>&nbsp;Valider</button>
                    <button id="btnCancelAddDocument" type="button" class="btn" data-dismiss="modal">Annuler</button>
                </div>
                <div ng-show="editmode == 'View'">
                    <button id="btnFermerVisuDocument" type="button" class="btn btn-info" data-dismiss="modal"><span class="fa fa-check"></span>&nbsp;Fermer</button>
                </div>
            </div>

            <div class="loadingHidden overlay">
                <i class="fa fa-refresh fa-spin"></i>
            </div>
        </div>
    </div>
</div>
<!-- FIN MODAL AJOUT/MISE A JOUR/VISUALISATION DOCUMENT -->

<!-- DEBUT MODAL SUPPRESSION DOCUMENT -->
<div class="modal fade" id="modalDeleteDoc">
    <div class="modal-dialog modal-lg">
        <div class="modal-content loadable form-delete-document">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel" ng-bind="deleteModalLabel"></h4>
            </div>
            <div class="modal-body" style="padding-top:5px;">
                <div class="box-body" style="padding-top:0px;">

                    <!-- Message -->
                    <div class="text-center">
                        <h4 class="text-bold text-danger" ng-bind="deleteModalText"></h4>
                    </div>

                    <!-- Pièces -->
                    <div class="panel panel-info" ng-show="currentDocument.pieces.length != 0" style="margin-top: 2em; width: 50%; margin-left: 25%;">
                        <div class="panel-heading">
                            <h5 class="text-bold">Pièces jointes</h5>
                        </div>
                        <div class="panel-body">
                            <table class="table table-condensed table-striped">
                                <tr ng-repeat="piece in currentDocument.pieces">
                                    <td>{{piece.nom}}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                </div>
                <!-- /.box-body -->
            </div>

            <div class="modal-footer">
                <button id="btnOkDeleteDocument" type="button" ng-click="deleteDocument()" class="btn btn-danger"><span class="fa fa-trash"></span>&nbsp;Oui</button>
                <button id="btnCancelDeleteDocument" type="button" class="btn" data-dismiss="modal">Non</button>
            </div>

            <div class="loadingHidden overlay">
                <i class="fa fa-refresh fa-spin"></i>
            </div>
        </div>
    </div>
</div>
<!-- FIN MODAL SUPPRESSION DOCUMENT -->

<!-- DEBUT MODAL GESTION DES PIECES DU DOCUMENT -->
<div class="modal fade" id="modalGestionPieces" nv-file-drop="" uploader="uploader" filters="queueLimit, customFilter">
    <div class="modal-dialog modal-lg">
        <div class="modal-content loadable form-gestion-pieces">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel" ng-bind="gestionPiecesModalLabel"></h4>
            </div>
            <div class="modal-body" style="padding-top:5px;">
                <div class="panel panel-info" style="margin-top: 2em; width: 70%; margin-left: 15%;">
                    <div class="panel-heading">
                        <h5 class="text-bold">Pièces jointes ({{currentDocument.pieces.length}})</h5>
                    </div>
                    <div class="panel-body">
                        <table class="table table-condensed table-striped">
                            <tr ng-repeat="piece in currentDocument.pieces">
                                <td width="80%">{{piece.nom}}</td>
                                <td class="text-center" ng-click="askViewPiece(piece)" style="cursor: pointer"><i class="fa fa-eye"></i></td>
                                <td class="text-center" ng-click="askDeletePiece(piece)" style="cursor: pointer"><i class="fa fa-remove text-danger"></i></td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="panel panel-info" style="margin-top: 2em; width: 70%; margin-left: 15%;">
                    <div class="panel-heading">
                        <h5 class="text-bold">Ajouter une pièce</h5>
                    </div>
                    <div class="panel-body">
                        <input type="file" nv-file-select="" uploader="uploader" multiple style="width: 100%;" />
                        <div>

                            <table class="table">
                                <thead>
                                    <tr>
                                        <th width="80%">Nom</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="item in uploader.queue">
                                        <td><strong>{{ item.file.name }}</strong></td>
                                        <td nowrap>
                                            <button type="button" class="btn btn-success btn-xs" ng-click="item.upload()" ng-disabled="item.isReady || item.isUploading || item.isSuccess">
                                                <span class="glyphicon glyphicon-upload"></span> Charger
                                            </button>
                                            <button type="button" class="btn btn-danger btn-xs" ng-click="item.remove()">
                                                <span class="glyphicon glyphicon-trash"></span> Supprimer
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                        </div>

                        <div>
                            <div>
                                Avancement:
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" ng-style="{ 'width': uploader.progress + '%' }"></div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-danger btn-s" ng-click="uploader.clearQueue()" ng-disabled="!uploader.queue.length">
                                    <span class="glyphicon glyphicon-trash"></span> Tout supprimer
                                </button>
                        </div>


                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div>
                    <button id="btnFermerGestionPieces" type="button" class="btn btn-info" data-dismiss="modal"><span class="fa fa-check"></span>&nbsp;Fermer</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- FIN MODAL GESTION DES PIECES DU DOCUMENT -->